<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診察文字起こし分析ツール (Gemini)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Wordファイル読み込み用ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        /* テーブルのスタイル調整 */
        .result-table th {
            background-color: #f3f4f6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .result-table td {
            vertical-align: middle;
        }

        /* 読み込み中のスピナー */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* トースト通知 */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- ヘッダー -->
    <header class="bg-white shadow-sm z-20 flex-none relative">
        <div class="max-w-[1920px] mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                    <i class="fa-solid fa-file-medical-alt text-lg"></i>
                </div>
                <h1 class="text-lg font-bold text-slate-700">診察文字起こし分析ツール</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="openSettings()"
                    class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 rounded-lg transition border border-slate-200">
                    <i class="fa-solid fa-gear"></i> 設定
                </button>
            </div>
        </div>
    </header>

    <!-- ツールバー (ファイル操作) -->
    <div class="bg-white border-b border-slate-200 px-4 py-3 shadow-sm z-10 flex-none">
        <div class="max-w-[1920px] mx-auto flex items-center gap-4">

            <!-- ファイル選択ボタン -->
            <label
                class="cursor-pointer flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition border border-slate-300 font-medium text-sm">
                <i class="fa-solid fa-folder-open"></i> ファイルを選択
                <input type="file" id="fileInput" accept=".txt,.csv,.md,.log,.docx" class="hidden"
                    onchange="handleFileUpload(event)">
            </label>

            <!-- ファイル情報 -->
            <div class="flex items-center gap-2 text-sm text-slate-600 border-l border-slate-300 pl-4 h-8">
                <i class="fa-regular fa-file-lines text-slate-400"></i>
                <span id="fileNameDisplay" class="font-mono font-medium max-w-[300px] truncate">ファイル未選択</span>
                <span id="charCountDisplay" class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full ml-2">-
                    文字</span>
            </div>

            <!-- 分析ボタン -->
            <div class="flex-1"></div> <!-- スペーサー -->

            <!-- モデル表示バッジ (新規追加) -->
            <div class="hidden md:flex items-center gap-2 text-xs text-slate-500 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200 mr-2"
                title="現在使用中のモデルID">
                <i class="fa-solid fa-microchip text-slate-400"></i>
                <span id="toolbarModelDisplay">Model: -</span>
            </div>

            <button id="analyzeBtn" onclick="analyzeTranscript()"
                class="flex items-center gap-2 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md transition font-bold text-sm opacity-50 cursor-not-allowed"
                disabled>
                <i class="fa-solid fa-magnifying-glass"></i> 分析開始 (2回並列)
            </button>
        </div>
    </div>

    <!-- メインコンテンツ (フル幅) -->
    <main class="flex-1 flex overflow-hidden w-full p-4 gap-4 bg-slate-100">

        <!-- 結果エリア (左右分割) -->
        <div class="flex-1 flex flex-col gap-2 rounded-xl p-0 relative overflow-hidden h-full">

            <!-- 空の状態 -->
            <div id="emptyState"
                class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-white rounded-xl border border-slate-200">
                <i class="fa-solid fa-table-columns text-5xl mb-4 text-slate-200"></i>
                <p class="text-lg text-slate-500">ファイルを読み込んで分析を開始してください</p>
                <p class="text-sm text-slate-400 mt-2">結果が左右に並んで表示され、比較検討できます</p>
            </div>

            <!-- ローディング -->
            <div id="loadingState"
                class="hidden absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-20 backdrop-blur-sm rounded-xl">
                <div class="loader mb-4 scale-125"></div>
                <h3 class="text-xl font-bold text-slate-700">Geminiが分析中...</h3>
                <p class="text-slate-500 mt-1">2つのパターンで並列処理を実行しています</p>
            </div>

            <!-- 結果ラッパー (左右分割) -->
            <div id="resultWrapper" class="hidden flex-row gap-4 h-full w-full">

                <!-- 結果1 (左カラム) -->
                <div
                    class="flex-1 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden min-w-0">
                    <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center flex-none">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span
                                class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded border border-blue-200 whitespace-nowrap">分析結果
                                1</span>
                            <span class="text-xs text-slate-500 truncate" id="count1">0件</span>
                        </div>
                        <div class="flex gap-1 flex-none">
                            <button onclick="copyForSpreadsheet(1)"
                                class="px-2 py-1 text-xs bg-white hover:bg-green-50 text-slate-600 hover:text-green-700 border border-slate-200 hover:border-green-200 rounded transition"
                                title="コピー">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                            <button onclick="downloadCSV(1)"
                                class="px-2 py-1 text-xs bg-white hover:bg-blue-50 text-slate-600 hover:text-blue-700 border border-slate-200 hover:border-blue-200 rounded transition"
                                title="CSV保存">
                                <i class="fa-solid fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto bg-white">
                        <table class="w-full text-sm text-left result-table border-collapse">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100 border-b">
                                <tr>
                                    <th class="px-3 py-2 border-r w-24 whitespace-nowrap">日付</th>
                                    <th class="px-2 py-2 border-r w-12 whitespace-nowrap">No.</th>
                                    <th class="px-2 py-2 border-r w-20 whitespace-nowrap">種別</th>
                                    <th class="px-3 py-2 border-r min-w-[200px] w-1/3">会話</th>
                                    <th class="px-3 py-2 min-w-[200px]">要約</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody1" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- 結果2 (右カラム) -->
                <div
                    class="flex-1 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden min-w-0">
                    <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center flex-none">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span
                                class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded border border-indigo-200 whitespace-nowrap">分析結果
                                2</span>
                            <span class="text-xs text-slate-500 truncate" id="count2">0件</span>
                        </div>
                        <div class="flex gap-1 flex-none">
                            <button onclick="copyForSpreadsheet(2)"
                                class="px-2 py-1 text-xs bg-white hover:bg-green-50 text-slate-600 hover:text-green-700 border border-slate-200 hover:border-green-200 rounded transition"
                                title="コピー">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                            <button onclick="downloadCSV(2)"
                                class="px-2 py-1 text-xs bg-white hover:bg-blue-50 text-slate-600 hover:text-blue-700 border border-slate-200 hover:border-blue-200 rounded transition"
                                title="CSV保存">
                                <i class="fa-solid fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto bg-white">
                        <table class="w-full text-sm text-left result-table border-collapse">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100 border-b">
                                <tr>
                                    <th class="px-3 py-2 border-r w-24 whitespace-nowrap">日付</th>
                                    <th class="px-2 py-2 border-r w-12 whitespace-nowrap">No.</th>
                                    <th class="px-2 py-2 border-r w-20 whitespace-nowrap">種別</th>
                                    <th class="px-3 py-2 border-r min-w-[200px] w-1/3">会話</th>
                                    <th class="px-3 py-2 min-w-[200px]">要約</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody2" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- ステータスバー (下部にも残す) -->
            <div class="text-xs text-slate-500 mt-auto pt-1 flex justify-between flex-none px-1">
                <span id="modelDisplay">Model: 未設定</span>
                <span id="statusMessage">待機中</span>
            </div>
        </div>
    </main>

    <!-- トースト通知 -->
    <div id="toast">クリップボードにコピーしました。<br>スプレッドシートで「貼り付け」してください。</div>

    <!-- 設定モーダル -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                <i class="fa-solid fa-sliders"></i> 設定
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Google Gemini API Key</label>
                    <input type="password" id="apiKeyInput"
                        class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="AIzaSy...">
                    <p class="text-xs text-slate-500 mt-1">※キーはブラウザ内にのみ一時保存され、外部には送信されません。</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">使用モデル (Model ID)</label>
                    <select id="modelInput"
                        class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="gemini-3-flash-preview">gemini-3-flash-preview (高速・低コスト)</option>
                        <option value="gemini-3-pro-preview">gemini-3-pro-preview (高精度)</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">
                        用途に応じてモデルを選択してください。
                    </p>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeSettings()"
                    class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">キャンセル</button>
                <button onclick="saveSettings()"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow">保存する</button>
            </div>
        </div>
    </div>

    <script>
        // --- 設定管理 ---
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let modelId = localStorage.getItem('gemini_model_id') || 'gemini-3-flash-preview';
        let currentFileName = ""; // アップロードされたファイル名を保持
        let loadedTranscriptText = ""; // 読み込んだテキストデータを保持

        // ユーザー指定のプロンプト
        const SYSTEM_PROMPT = `
# 役割

あなたは、臨床面談やカウンセリングの文字起こしデータ（逐語録）を分析する専門的なアシスタントです。

# 目的

入力された診察外来の診察記録（文字起こし）を分析し、以下の定義に基づく「注目すべき会話パターン」を特定してください。

特定した結果は、指定された出力形式（5列の表）で報告してください。

# 分析の定義

以下の2つのパターンに該当する箇所を特定してください。

1.  **会話ラリー（議論・やり取り）**

      - **定義**: 医師と患者が、比較的短い発言（例：1〜3文程度）を**連続して5往復以上（合計10ターン以上）**活発に交換している箇所。
      - **除外**: 単純な相槌（「はい」「ええ」「うーん」）のみのやり取りはカウントしません。

2.  **患者の長い発話（モノローグ）**

      - **定義**: 医師からの短い相槌や最小限の質問（例：「それで？」「他には？」）を挟むだけで、患者が実質的に連続して5文以上（または目安として150文字以上）一人で話し続けている箇所。

# 出力形式

特定したすべての該当箇所を、以下の5つの列を持つ表形式（マークダウン形式の表）で出力してください。
**マークダウンの表形式以外（冒頭の挨拶や説明など）は一切出力しないでください。**

該当箇所がない場合は、表の中に「該当なし」と記述してください。

| 日付 | 受付番号 | 種別 | 実際の会話（抜粋） | 内容の要約 |
| :--- | :--- | :--- | :--- | :--- |
| 2025/12/27 | 6 | ラリー | 医師:〜<br>患者:〜 | 【タイトル】要約内容 |
| 2025/12/27 | - | モノローグ | 患者:〜 | 【タイトル】要約内容 |

**列の詳細指示:**
- **日付**: 入力されたテキストの冒頭にある「ファイル名」またはテキスト内の情報から日付を特定し、**YYYY/MM/DD形式**（例: 2025/12/27）で出力してください。ファイル名が日付形式を含まない場合（例: data.txt）は、ファイル名をそのまま記述してください。
- **受付番号**: 「番」や「の方」などの接尾辞は一切付けず、**半角数字のみ**（例：6, 15）。**受付番号が不明・存在しない場合は「-」を記入してください。受付番号がなくても、該当する会話パターンがあれば必ず報告してください。**
- **種別**: 「ラリー」または「モノローグ」。
- **実際の会話（抜粋）**: 「患者:」「医師:」を付け、文脈が通じる範囲で記述。
- **内容の要約**: **【要約タイトル】詳細な説明** の形式。

# 重要な注意事項

**受付番号の有無に関わらず、すべての該当箇所を漏れなく報告してください。** 受付番号がない場合でも、会話パターン（ラリー・モノローグ）が検出されれば、受付番号を「-」として必ず表に含めてください。

# 制約事項

  - 文字起こしのテキストのみに基づいて、上記の定義に合致する箇所を客観的に分析してください。
  - 医学的な解釈、診断、評価は一切行わないでください。
  - 「実際の会話（抜粋）」は、分析の根拠となる具体的なテキストをそのまま引用してください。
`;

        // 初期表示更新
        updateStatusDisplay();

        function openSettings() {
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('modelInput').value = modelId;
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }

        function saveSettings() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            modelId = document.getElementById('modelInput').value.trim();

            localStorage.setItem('gemini_api_key', apiKey);
            localStorage.setItem('gemini_model_id', modelId);

            updateStatusDisplay();
            closeSettings();
        }

        function updateStatusDisplay() {
            const text = `Model: ${modelId}`;
            // 下部のステータスバー
            const footerDisplay = document.getElementById('modelDisplay');
            if (footerDisplay) footerDisplay.innerText = text;
            // 上部ツールバーのバッジ
            const toolbarDisplay = document.getElementById('toolbarModelDisplay');
            if (toolbarDisplay) toolbarDisplay.innerText = text;
        }

        // --- ファイルアップロード処理 ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFileName = file.name; // ファイル名を保存

            // ファイル情報を表示
            document.getElementById('fileNameDisplay').innerText = currentFileName;
            document.getElementById('fileNameDisplay').classList.remove('text-slate-400');
            document.getElementById('fileNameDisplay').classList.add('text-slate-700');
            document.getElementById('charCountDisplay').innerText = "読み込み中...";

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            const filename = file.name.toLowerCase();

            const onReadSuccess = (text) => {
                loadedTranscriptText = text;
                document.getElementById('charCountDisplay').innerText = `${text.length.toLocaleString()} 文字`;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            };

            const onReadError = (msg) => {
                alert(msg || "ファイルの読み込みに失敗しました。");
                loadedTranscriptText = "";
                document.getElementById('fileNameDisplay').innerText = "読み込みエラー";
                document.getElementById('fileNameDisplay').classList.add('text-red-500');
            };

            // Wordファイル (.docx) の場合
            if (filename.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const arrayBuffer = e.target.result;
                    mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                        .then(function (result) {
                            if (result.messages && result.messages.length > 0) {
                                console.log("Word read warnings:", result.messages);
                            }
                            onReadSuccess(result.value);
                        })
                        .catch(function (err) {
                            console.error(err);
                            onReadError("Wordファイルの読み込みに失敗しました。");
                        });
                };
                reader.onerror = () => onReadError();
                reader.readAsArrayBuffer(file);
            }
            // テキスト系ファイルの場合 (.txt, .md, .csv, .log など)
            else {
                const reader = new FileReader();
                reader.onload = function (e) {
                    onReadSuccess(e.target.result);
                };
                reader.onerror = () => onReadError();
                reader.readAsText(file);
            }

            // 同じファイルを再度選べるようにリセット
            event.target.value = '';
        }

        // --- 分析ロジック ---
        let currentResults1 = []; // 結果1
        let currentResults2 = []; // 結果2

        async function callGeminiAPI(text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
                generationConfig: {
                    temperature: 0.2,
                }
            };
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || 'API Error');
            }
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        }

        async function analyzeTranscript() {
            if (!apiKey) {
                alert('設定ボタンからAPIキーを設定してください。');
                openSettings();
                return;
            }
            if (!loadedTranscriptText) {
                alert('ファイルを読み込んでください。');
                return;
            }

            // ファイル名情報をテキストに付加してAIに渡す
            const textToAnalyze = `【分析対象ファイル名】: ${currentFileName || "不明"}\n\n${loadedTranscriptText}`;

            // UIリセット
            const btn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loadingState');
            const empty = document.getElementById('emptyState');
            const resultWrapper = document.getElementById('resultWrapper');
            const status = document.getElementById('statusMessage');

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            loading.classList.remove('hidden');
            empty.classList.add('hidden');
            resultWrapper.classList.add('hidden');
            resultWrapper.classList.remove('flex'); // hidden解除時にflexが必要だが、一旦隠す
            status.innerText = "分析中(2回並列実行)...";

            try {
                // 2回並列実行
                const promises = [
                    callGeminiAPI(textToAnalyze),
                    callGeminiAPI(textToAnalyze)
                ];

                const results = await Promise.all(promises);

                // パースして保存
                currentResults1 = parseMarkdownTable(results[0]);
                currentResults2 = parseMarkdownTable(results[1]);

                // テーブル描画
                renderTable(currentResults1, 'resultBody1', 'count1');
                renderTable(currentResults2, 'resultBody2', 'count2');

                // 完了状態へ
                loading.classList.add('hidden');
                resultWrapper.classList.remove('hidden');
                resultWrapper.classList.add('flex'); // flexに戻す
                status.innerText = "分析完了";

            } catch (error) {
                console.error(error);
                alert('エラーが発生しました: ' + error.message);
                status.innerText = "エラー発生";
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // MarkdownテーブルをJSON配列に変換する簡易パーサー
        function parseMarkdownTable(mdText) {
            const lines = mdText.split('\n');
            const data = [];

            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('|') && line.endsWith('|')) {
                    if (line.includes('---')) continue;

                    const cells = line.split('|').slice(1, -1).map(c => c.trim());

                    if (cells[0] === '日付' || cells[0] === '**日付**') continue;

                    if (cells.length >= 5) {
                        data.push({
                            date: cells[0],
                            id: cells[1],
                            type: cells[2],
                            conversation: cells[3].replace(/<br>/g, '\n'),
                            summary: cells[4].replace(/<br>/g, '\n')
                        });
                    }
                }
            }
            return data;
        }

        function renderTable(data, tbodyId, countId) {
            const tbody = document.getElementById(tbodyId);
            const countEl = document.getElementById(countId);

            tbody.innerHTML = '';
            countEl.innerText = `${data.length}件`;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500 text-xs">該当なし</td></tr>';
                return;
            }

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition border-b border-slate-100 group";

                const rawConv = row.conversation.replace(/<br>/g, '\n');
                const rawSum = row.summary.replace(/<br>/g, '\n');

                tr.innerHTML = `
                    <td class="px-3 py-2 border-r border-slate-100 text-slate-600 font-medium whitespace-nowrap leading-tight text-xs">${row.date}</td>
                    <td class="px-2 py-2 border-r border-slate-100 text-slate-600 leading-tight text-xs">${row.id}</td>
                    <td class="px-2 py-2 border-r border-slate-100">
                        <span class="inline-block px-1.5 py-0.5 text-[10px] font-semibold rounded-full border 
                            ${row.type.includes('ラリー') ? 'bg-orange-50 text-orange-700 border-orange-100' : 'bg-purple-50 text-purple-700 border-purple-100'}">
                            ${row.type}
                        </span>
                    </td>
                    <td class="px-3 py-2 border-r border-slate-100 text-slate-700 text-xs leading-tight max-w-xs truncate cursor-help group-hover:text-slate-900" title="${rawConv}">${row.conversation}</td>
                    <td class="px-3 py-2 text-slate-700 text-xs leading-tight max-w-sm truncate cursor-help group-hover:text-slate-900" title="${rawSum}">${row.summary}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // CSVダウンロード (BOM付きUTF-8)
        function downloadCSV(resultNum) {
            const data = resultNum === 1 ? currentResults1 : currentResults2;
            if (data.length === 0) return;

            let csvContent = "日付,受付番号,種別,実際の会話（抜粋）,内容の要約\n";

            data.forEach(row => {
                const escape = (text) => `"${(text || '').replace(/"/g, '""')}"`;

                const line = [
                    escape(row.date),
                    escape(row.id),
                    escape(row.type),
                    escape(row.conversation),
                    escape(row.summary)
                ].join(",");

                csvContent += line + "\n";
            });

            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });

            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const timestamp = new Date().toISOString().replace(/[:.]/g, "-").slice(0, 19);
            link.setAttribute("download", `analysis_result_${resultNum}_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // スプレッドシート用にコピー (TSV形式)
        function copyForSpreadsheet(resultNum) {
            const data = resultNum === 1 ? currentResults1 : currentResults2;
            if (data.length === 0) return;

            let tsvContent = "日付\t受付番号\t種別\t実際の会話（抜粋）\t内容の要約\n";

            data.forEach(row => {
                const escape = (text) => `"${(text || '').replace(/"/g, '""')}"`;
                const line = [
                    escape(row.date),
                    escape(row.id),
                    escape(row.type),
                    escape(row.conversation),
                    escape(row.summary)
                ].join("\t");
                tsvContent += line + "\n";
            });

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(tsvContent).then(() => {
                    showToast();
                }).catch(err => {
                    console.warn('Clipboard API blocked, falling back to execCommand:', err);
                    fallbackCopyTextToClipboard(tsvContent);
                });
            } else {
                fallbackCopyTextToClipboard(tsvContent);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) showToast();
                else alert('コピーに失敗しました。');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('コピーに失敗しました。');
            }
            document.body.removeChild(textArea);
        }

        function showToast() {
            const toast = document.getElementById("toast");
            toast.className = "show";
            setTimeout(function () { toast.className = toast.className.replace("show", ""); }, 4000);
        }
    </script>
</body>

</html>